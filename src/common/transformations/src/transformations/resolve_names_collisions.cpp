// Copyright (C) 2018-2023 Intel Corporation
// SPDX-License-Identifier: Apache-2.0
//

#include "transformations/resolve_names_collisions.hpp"

#include <algorithm>
#include <memory>
#include <numeric>

#include "itt.hpp"
#include "openvino/op/parameter.hpp"
#include "openvino/op/result.hpp"
#include "openvino/op/sink.hpp"

bool ov::pass::ResolveNameCollisions::run_on_model(const std::shared_ptr<ov::Model>& model) {
    // Next containers are used to fix collisions in autogenerated names
    // The final list of nodes with collisions
    RUN_ON_MODEL_SCOPE(ResolveNameCollisions);
    std::vector<Node*> nodes_with_conflicts;
    std::unordered_map<std::string, std::list<Node*>> visited_nodes;

    for (const auto& node : model->get_ordered_ops()) {
        // Collect a names collision map for all nodes in the graph
        const auto& friendly_name = node->get_friendly_name();
        visited_nodes[friendly_name].emplace_back(node.get());
    }

    for (const auto& it : visited_nodes) {
        const auto& same_named_ops = it.second;
        if (same_named_ops.size() > 1) {
            int64_t cnt = 2;

            for (const auto& op : same_named_ops) {
                // check if op has OV autogenerated friendly name. unique and friendly names have to be equal.
                bool is_autogenerated = op->get_friendly_name() == op->get_name();
                if (is_autogenerated) {
                    // add a prefix "_counter" to the autogenerated name to make it unique.
                    auto new_name = op->get_friendly_name() + "_" + std::to_string(cnt++);

                    int64_t safety_stop = 10000;
                    bool safety_stop_happened = false;
                    while (visited_nodes.find(new_name) != visited_nodes.end()) {
                        new_name = op->get_friendly_name() + "_" + std::to_string(cnt++);
                        if (cnt > safety_stop) {
                            safety_stop_happened = true;
                            break;
                        }
                    }

                    if (!safety_stop_happened) {
                        op->set_friendly_name(new_name);
                    }
                }
            }
        }
    }
    return true;
}
