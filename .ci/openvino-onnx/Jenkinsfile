
// Copyright (C) 2018-2020 Intel Corporation
// SPDX-License-Identifier: Apache-2.0

DOCKER_HOME = "/openvino"
DOCKER_CONTAINER_PREFIX = "jenkins_ngraph-onnx_ci"
DOCKER_CONTAINER_NAME="${DOCKER_CONTAINER_PREFIX}_${BUILD_NUMBER}"

def getGitPrInfo(String project) {
    def gitPrInfo = [
        prAuthorEmail : "",
        commitAuthorEmail : "",
        commitHash : "",
        commitSubject : ""
    ]
    try {
        dir ("${WORKDIR}/${project}") {
            gitPrInfo.prAuthorEmail = sh (script: 'git log -1 --pretty="format:%ae" ', returnStdout: true).trim()
            gitPrInfo.commitAuthorEmail = sh (script: 'git log -1 --pretty="format:%ce" ', returnStdout: true).trim()
            gitPrInfo.commitSubject = sh (script: 'git log -1 --pretty="format:%H" ', returnStdout: true).trim()
            gitPrInfo.commitHash = sh (script: 'git log -1 --pretty="format:%s" ', returnStdout: true).trim()
        }
    }
    catch(e) {
        echo "Failed to retrieve ${project} git repository information!"
        echo "ERROR: ${e}"
    }
    return gitPrInfo
}

def notifyByEmail(def gitPrInfo) {
    stage('Notify') {
        String notifyPeople = "${gitPrInfo.prAuthorEmail}, ${gitPrInfo.commitAuthorEmail}"
        emailext (
            subject: "OpenVino CI: PR ${CHANGE_ID} ${currentBuild.result}!",
            body: """
                    Status: ${currentBuild.result}
                    Pull Request Title: ${CHANGE_TITLE}
                    Pull Request: ${CHANGE_URL}
                    Branch: ${CHANGE_BRANCH}
                    Commit Hash: ${gitPrInfo.commitSubject}
                    Commit Subject: ${gitPrInfo.commitHash}
                    Jenkins Build: ${RUN_DISPLAY_URL}
            """,
            to: "${notifyPeople}"
        )
    }
}

def gitSubmoduleUpdate(String repository_name) {
    dir ("${WORKDIR}/${repository_name}") {
        sh  label: "Init ${repository_name} submodules",
            script:
        """
            git submodule init && git submodule update \
                --init \
                --no-fetch \
                --recursive 
        """
    }
}

def runDockerContainer(String imageID) {
    CONTAINER_ID = sh (
    script: """
            docker run -id --privileged \
                    --name ${DOCKER_CONTAINER_NAME} \
                    --volume ${HOME}/ONNX_CI/onnx_models/.onnx:/root/.onnx \
                    ${imageID} tail -f /dev/null
            """,
    returnStdout: true
    ).trim()
}

def buildDockerImage() {
    sh """
        docker build --tag=openvino-onnx-ci  --file=.ci/openvino-onnx/Dockerfile \
        --build-arg http_proxy=http://proxy-chain.intel.com:911/ \
        --build-arg https_proxy=http://proxy-chain.intel.com:912/ .
    """
    IMAGE_ID = sh (
    script: """
            docker images -f="reference=openvino-onnx-ci" -q
            """,
            returnStdout: true
            ).trim()
}

def runTests() {
    PYTHONPATH = "/openvino/bin/intel64/Release/lib/python_api/python3.8"
    sh """
        docker exec -e NGRAPH_CPP_BUILD_PATH=/openvino/dist \
                    -e LD_LIBRARY_PATH=/openvino/dist/lib \
                    -e NGRAPH_ONNX_IMPORT_ENABLE=TRUE \
                    -e PYTHONPATH=${PYTHONPATH} \
                    -w ${DOCKER_HOME}/ngraph/python ${CONTAINER_ID} tox
    """
}

def dockerRemove(String container_ID) {
    sh """
        docker rm -f ${container_ID}
    """
}

pipeline {
    agent {
        label "OpenVino"
    }
    environment {
        PROJECT_NAME = "openvino"
        WORKDIR = "${WORKSPACE}/${BUILD_NUMBER}"
    }
    options {
        skipDefaultCheckout true
    }
    stages {
        stage("Clone repository") {
            steps{
                dir("${WORKDIR}") {
                    checkout scm
                }
                gitSubmoduleUpdate(PROJECT_NAME)
            }
        }
        stage("Prepare Docker environment") {
            steps{
                dir("${WORKDIR}") {
                    buildDockerImage()
                    runDockerContainer("${IMAGE_ID}")
                }
            }
        }
        stage("Run tests") {
            steps{
                runTests()
            }
        }
    }
    post {
        failure {
            script {
                gitPrInfo = getGitPrInfo(PROJECT_NAME)
                notifyByEmail(gitPrInfo)
            }
        }
        cleanup {
            dir("${WORKDIR}") {
                deleteDir()
                sh """
                    docker image prune -f
                """
                dockerRemove("${CONTAINER_ID}")
            }
        }
    }
}
